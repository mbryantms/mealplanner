{% extends "base.html" %}

{% block title %}Recipes - Family Meal Planner{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h1 class="text-2xl font-bold text-gray-900">Recipes</h1>
        <div class="flex gap-2">
            <a href="{% url 'recipes:recipe_import' %}"
               class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Import
            </a>
            <a href="{% url 'recipes:recipe_create' %}"
               class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Recipe
            </a>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow-sm p-4 space-y-3">
        <form method="get" id="recipe-filter-form">
            <!-- Search -->
            <div class="flex-grow">
                <label for="recipe-search" class="sr-only">Search recipes</label>
                <input type="text" name="q" id="recipe-search" value="{{ search_query }}"
                       placeholder="Search recipes..."
                       class="block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       hx-get="{% url 'recipes:recipe_list' %}"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#recipe-list"
                       hx-push-url="true"
                       hx-include="[name='cuisines'], [name='proteins'], [name='dish_types'], [name='tags']">
            </div>

            <!-- Filter Sections -->
            <div class="flex flex-wrap gap-2 mt-3">
                <!-- Cuisine Filter -->
                {% if form.cuisines.field.queryset.exists %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md border
                                   {% if request.GET.cuisines %}bg-amber-100 text-amber-800 border-amber-300{% else %}bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100{% endif %}">
                        <span>Cuisine</span>
                        {% if request.GET.cuisines %}
                        <span class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-amber-600 rounded-full">
                            {{ request.GET.cuisines|length }}
                        </span>
                        {% endif %}
                        <svg class="w-4 h-4 ml-1.5 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute z-10 mt-1 w-64 bg-white rounded-md shadow-lg border border-gray-200 p-3">
                        <div class="flex flex-wrap gap-2">
                            {% for checkbox in form.cuisines %}
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="cuisines" value="{{ checkbox.data.value }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="sr-only peer"
                                       hx-get="{% url 'recipes:recipe_list' %}"
                                       hx-trigger="change"
                                       hx-target="#recipe-list"
                                       hx-push-url="true"
                                       hx-include="[name='q'], [name='cuisines'], [name='proteins'], [name='dish_types'], [name='tags']">
                                <span class="px-2.5 py-1 text-sm font-medium rounded-full transition-colors
                                             peer-checked:bg-amber-600 peer-checked:text-white
                                             bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    {{ checkbox.choice_label }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Protein Filter -->
                {% if form.proteins.field.queryset.exists %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md border
                                   {% if request.GET.proteins %}bg-rose-100 text-rose-800 border-rose-300{% else %}bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100{% endif %}">
                        <span>Protein</span>
                        {% if request.GET.proteins %}
                        <span class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-rose-600 rounded-full">
                            {{ request.GET.proteins|length }}
                        </span>
                        {% endif %}
                        <svg class="w-4 h-4 ml-1.5 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute z-10 mt-1 w-64 bg-white rounded-md shadow-lg border border-gray-200 p-3">
                        <div class="flex flex-wrap gap-2">
                            {% for checkbox in form.proteins %}
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="proteins" value="{{ checkbox.data.value }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="sr-only peer"
                                       hx-get="{% url 'recipes:recipe_list' %}"
                                       hx-trigger="change"
                                       hx-target="#recipe-list"
                                       hx-push-url="true"
                                       hx-include="[name='q'], [name='cuisines'], [name='proteins'], [name='dish_types'], [name='tags']">
                                <span class="px-2.5 py-1 text-sm font-medium rounded-full transition-colors
                                             peer-checked:bg-rose-600 peer-checked:text-white
                                             bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    {{ checkbox.choice_label }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Dish Type Filter -->
                {% if form.dish_types.field.queryset.exists %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md border
                                   {% if request.GET.dish_types %}bg-indigo-100 text-indigo-800 border-indigo-300{% else %}bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100{% endif %}">
                        <span>Dish Type</span>
                        {% if request.GET.dish_types %}
                        <span class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-indigo-600 rounded-full">
                            {{ request.GET.dish_types|length }}
                        </span>
                        {% endif %}
                        <svg class="w-4 h-4 ml-1.5 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute z-10 mt-1 w-64 bg-white rounded-md shadow-lg border border-gray-200 p-3">
                        <div class="flex flex-wrap gap-2">
                            {% for checkbox in form.dish_types %}
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="dish_types" value="{{ checkbox.data.value }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="sr-only peer"
                                       hx-get="{% url 'recipes:recipe_list' %}"
                                       hx-trigger="change"
                                       hx-target="#recipe-list"
                                       hx-push-url="true"
                                       hx-include="[name='q'], [name='cuisines'], [name='proteins'], [name='dish_types'], [name='tags']">
                                <span class="px-2.5 py-1 text-sm font-medium rounded-full transition-colors
                                             peer-checked:bg-indigo-600 peer-checked:text-white
                                             bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    {{ checkbox.choice_label }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tags Filter -->
                {% if form.tags.field.queryset.exists %}
                <div class="relative" x-data="{ open: false }">
                    <button type="button" @click="open = !open"
                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md border
                                   {% if request.GET.tags %}bg-blue-100 text-blue-800 border-blue-300{% else %}bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100{% endif %}">
                        <span>Tags</span>
                        {% if request.GET.tags %}
                        <span class="ml-1.5 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 rounded-full">
                            {{ request.GET.tags|length }}
                        </span>
                        {% endif %}
                        <svg class="w-4 h-4 ml-1.5 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute z-10 mt-1 w-80 bg-white rounded-md shadow-lg border border-gray-200 p-3">
                        <div class="flex flex-wrap gap-2">
                            {% for checkbox in form.tags %}
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="tags" value="{{ checkbox.data.value }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="sr-only peer"
                                       hx-get="{% url 'recipes:recipe_list' %}"
                                       hx-trigger="change"
                                       hx-target="#recipe-list"
                                       hx-push-url="true"
                                       hx-include="[name='q'], [name='cuisines'], [name='proteins'], [name='dish_types'], [name='tags']">
                                <span class="px-2.5 py-1 text-sm font-medium rounded-full transition-colors
                                             peer-checked:bg-blue-600 peer-checked:text-white
                                             bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    {{ checkbox.choice_label }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Clear Filters -->
                {% if request.GET.cuisines or request.GET.proteins or request.GET.dish_types or request.GET.tags %}
                <a href="{% url 'recipes:recipe_list' %}{% if search_query %}?q={{ search_query }}{% endif %}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Clear filters
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Recipe List -->
    <div id="recipe-list">
        {% include "recipes/partials/recipe_list.html" %}
    </div>
</div>

<!-- Add to Meal Plan Modal -->
<div id="add-to-plan-modal-container"
     x-data="{ open: false }"
     @open-plan-modal.window="open = true"
     @close-modal.window="open = false; document.getElementById('add-to-plan-modal').innerHTML = ''"
     @keydown.escape.window="if (open) { open = false; document.getElementById('add-to-plan-modal').innerHTML = '' }">
    <div x-show="open"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         aria-labelledby="modal-title"
         role="dialog"
         aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
            <!-- Backdrop -->
            <div x-show="open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="open = false; document.getElementById('add-to-plan-modal').innerHTML = ''"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

            <!-- Modal Content -->
            <div x-show="open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 id="add-to-plan-modal"
                 class="relative z-10 flex items-center justify-center">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
