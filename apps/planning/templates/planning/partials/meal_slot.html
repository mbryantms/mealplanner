{% load planning_tags %}
<div class="meal-slot p-2 h-full flex flex-col gap-1"
     data-date="{{ date|date:'Y-m-d' }}"
     data-meal-type="{{ meal_type }}">

    {% for meal in meals %}
    <!-- Meal card -->
    <div class="group relative rounded-md p-2 cursor-grab active:cursor-grabbing
                {% if meal_type == 'breakfast' %}bg-yellow-100 hover:bg-yellow-200
                {% elif meal_type == 'lunch' %}bg-green-100 hover:bg-green-200
                {% else %}bg-blue-100 hover:bg-blue-200{% endif %}"
         draggable="true"
         @dragstart="handleDragStart($event, '{{ meal.pk }}')"
         @dragend="handleDragEnd($event)">

        <div class="flex items-start justify-between gap-2">
            <div class="flex-grow min-w-0">
                {% if meal.recipe %}
                <a href="{% url 'recipes:recipe_detail' meal.recipe.pk %}"
                   class="font-medium text-sm text-gray-900 hover:text-blue-600 line-clamp-2 block">
                    {{ meal.recipe.name }}
                </a>
                {% if meal.recipe.total_time or meal.servings_override %}
                <div class="flex items-center gap-2 mt-0.5 text-xs text-gray-500">
                    {% if meal.recipe.total_time %}
                    <span class="inline-flex items-center">
                        <svg class="w-3 h-3 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {{ meal.recipe.total_time }} min
                    </span>
                    {% endif %}
                    {% if meal.servings_override %}
                    <span>({{ meal.servings_override }} servings)</span>
                    {% endif %}
                </div>
                {% endif %}
                {% else %}
                <span class="font-medium text-sm text-gray-700 line-clamp-2 block">
                    {{ meal.custom_meal }}
                </span>
                {% endif %}
            </div>

            <!-- Actions dropdown -->
            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity relative"
                 x-data="{ open: false }">
                <button @click.stop="open = !open"
                        class="p-1 rounded hover:bg-white/50"
                        aria-haspopup="true"
                        :aria-expanded="open">
                    <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                    <span class="sr-only">Meal options</span>
                </button>
                <div x-show="open"
                     @click.away="open = false"
                     x-cloak
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 bottom-full mb-1 w-32 bg-white rounded-md shadow-lg z-50 border border-gray-200 py-1"
                     role="menu">
                    <button @click="openModal('{% url 'planning:meal_edit' meal.pk %}'); open = false"
                            class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            role="menuitem">
                        Edit
                    </button>
                    <button @click="openModal('{% url 'planning:meal_delete' meal.pk %}'); open = false"
                            class="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100"
                            role="menuitem">
                        Remove
                    </button>
                </div>
            </div>
        </div>

        {% if meal.notes %}
        <p class="mt-1 text-xs text-gray-500 line-clamp-1">{{ meal.notes }}</p>
        {% endif %}
    </div>
    {% endfor %}

    <!-- Add meal button (always visible) -->
    <button @click="openModal('{% url 'planning:meal_add' %}?date={{ date|date:'Y-m-d' }}&meal_type={{ meal_type }}')"
            class="w-full {% if meals %}min-h-8{% else %}min-h-16 h-full{% endif %} flex items-center justify-center rounded-md border-2 border-dashed border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-colors">
        <span class="text-gray-400 text-sm">
            <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            {% if not mobile %}
            <span class="sr-only">Add {{ meal_type }}</span>
            {% endif %}
        </span>
    </button>
</div>
